# Configuration VPS Production - Vital Sync

## ğŸ—ï¸ Architecture Fonctionnelle (17/06/2025)

### **Services dÃ©ployÃ©s et opÃ©rationnels :**

- âœ… **App Next.js** : `https://app.vital-sync.ch`
- âœ… **Supabase Studio** : `https://admin.vital-sync.ch`  
- âœ… **API Supabase** : `https://api.vital-sync.ch`
- âœ… **Traefik Dashboard** : Port 8080 (interne)
- âœ… **Portainer** : Ports 8000, 9443

### **RÃ©seaux Docker :**
- `traefik` : RÃ©seau principal (172.18.0.0/16)
- `supabase_default` : RÃ©seau Supabase interne

### **Certificats SSL :**
- âœ… Let's Encrypt automatique via Traefik
- âœ… Renouvellement automatique

---

## ğŸ“ Structure des dossiers

```
/home/
â”œâ”€â”€ patient-management-current/     # Application Next.js
â”‚   â”œâ”€â”€ compose.yaml               # Docker Compose de l'app
â”‚   â”œâ”€â”€ Dockerfile                 # Image Next.js optimisÃ©e
â”‚   â”œâ”€â”€ .env.production           # Variables d'environnement
â”‚   â””â”€â”€ prisma/schema.prisma      # SchÃ©ma base de donnÃ©es
â”œâ”€â”€ supabase-project/              # Backend Supabase
â”‚   â””â”€â”€ docker-compose.yml        # Stack Supabase complÃ¨te
â””â”€â”€ traefik-config/                # Reverse proxy
    â”œâ”€â”€ docker-compose.yml         # Traefik + Auth
    â””â”€â”€ config/                    # Configuration Traefik
```

---

## ğŸ”§ Fichiers de configuration critiques

### **1. App Next.js (`/home/patient-management-current/compose.yaml`)**
```yaml
services:
  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: entretien-infirmier-app
    restart: unless-stopped
    networks:
      - traefik
      - supabase_default
    env_file:
      - .env.production
    labels:
      # Router HTTP (redirection vers HTTPS)
      - "traefik.enable=true"
      - "traefik.http.routers.myapp-web.rule=Host(`app.vital-sync.ch`)"
      - "traefik.http.routers.myapp-web.entrypoints=web"
      - "traefik.http.routers.myapp-web.middlewares=https-redirect"
      
      # Router HTTPS
      - "traefik.http.routers.myapp.rule=Host(`app.vital-sync.ch`)"
      - "traefik.http.routers.myapp.entrypoints=websecure"
      - "traefik.http.routers.myapp.tls.certresolver=letsencrypt"
      
      # Service
      - "traefik.http.services.myapp.loadbalancer.server.port=3000"
      
      # Middleware de redirection HTTPS
      - "traefik.http.middlewares.https-redirect.redirectscheme.scheme=https"
      - "traefik.http.middlewares.https-redirect.redirectscheme.permanent=true"

networks:
  traefik:
    external: true
  supabase_default:
    external: true
```

### **2. Dockerfile optimisÃ© (Multi-stage avec fichiers statiques)**
- âœ… Build Next.js en mode standalone
- âœ… Copie des fichiers statiques (.next/static/)
- âœ… Utilisateur non-root pour la sÃ©curitÃ©
- âœ… Variables d'environnement de production

### **3. Variables d'environnement critiques**
```bash
NEXTAUTH_URL=https://app.vital-sync.ch
NEXT_PUBLIC_SUPABASE_URL=https://api.vital-sync.ch
DATABASE_URL=postgresql://postgres:PASSWORD@supabase-db:5432/postgres
NODE_ENV=production
```

---

## ğŸ—„ï¸ Base de donnÃ©es

### **Tables crÃ©Ã©es et fonctionnelles :**
- âœ… `auth_users` - Authentification
- âœ… `user_profiles` - Profils utilisateurs  
- âœ… `patients` - DonnÃ©es patients
- âœ… `entretiens` - Entretiens infirmiers
- âœ… `calendar_events` - Ã‰vÃ©nements calendrier
- âœ… Toutes les tables du schÃ©ma Prisma

### **Admin crÃ©Ã© :**
- âœ… Email : `l.daize@proton.me`
- âœ… RÃ´le : ADMIN
- âœ… Mot de passe : (dÃ©fini dans .env.production)

---

## ğŸš€ Processus de dÃ©ploiement validÃ©

### **1. Construction et dÃ©marrage :**
```bash
cd /home/patient-management-current
docker compose build --no-cache
docker compose up -d
```

### **2. Synchronisation base de donnÃ©es :**
```bash
# Copier le schÃ©ma Prisma
docker cp prisma/schema.prisma entretien-infirmier-app:/app/schema.prisma

# Appliquer le schÃ©ma
docker exec -it entretien-infirmier-app npx prisma db push --schema=/app/schema.prisma
```

### **3. CrÃ©ation d'utilisateurs :**
```bash
# Via SQL direct dans Supabase
docker exec -it supabase-db psql -U postgres -d postgres -c "..."
```

---

## âš ï¸ Points critiques Ã  ne pas modifier

1. **RÃ©seaux Docker** : `traefik` et `supabase_default` doivent rester externes
2. **Labels Traefik** : La configuration HTTP/HTTPS est critique
3. **Variables d'environnement** : NEXTAUTH_URL, DATABASE_URL
4. **Dockerfile** : Le multi-stage build avec fichiers statiques
5. **Port mapping** : L'app doit rester sur port 3000 interne

---

## ğŸ”„ Workflow dev â†’ prod recommandÃ©

### **Pour les modifications futures :**

1. **DÃ©veloppement local** avec `.env.local`
2. **Test en local** avec Docker si nÃ©cessaire  
3. **Commit/Push** vers Git
4. **Sur VPS** : Pull + rebuild sÃ©lectif
5. **VÃ©rification** que la config Docker reste intacte

### **Fichiers Ã  synchroniser Git â†” VPS :**
- âœ… Code source Next.js
- âœ… `package.json` / `package-lock.json`
- âœ… `prisma/schema.prisma`
- âš ï¸ **PAS** les fichiers `.env.production` (secrets)
- âš ï¸ **PAS** les `compose.yaml` (config VPS spÃ©cifique)

---

## ğŸ›¡ï¸ Sauvegardes automatiques

### **Ã€ mettre en place :**
```bash
# Script de sauvegarde hebdomadaire
# - Export base Supabase
# - Sauvegarde configuration Docker
# - Archive des images
```

---


## Recommandations pour le dÃ©veloppement futur :
### **1. Fichiers Ã  gitignorer cÃ´tÃ© VPS :**

*.env.production (secrets spÃ©cifiques VPS)*
*compose.yaml (config Docker VPS)*
*Certificats SSL*
*DonnÃ©es de base*

### **2. Workflow recommandÃ© :**

*Dev local â†’ Commit â†’ Push Git*
*VPS â†’ Pull Git â†’ Build sÃ©lectif*
*Jamais Ã©craser compose.yaml et .env.production*

**âœ… Configuration figÃ©e et documentÃ©e - PrÃªte pour le dÃ©veloppement !**



